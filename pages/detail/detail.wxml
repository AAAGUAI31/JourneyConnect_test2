<!--pages/detail/detail.wxml-->
<scroll-view scroll-y class="container">
  <!-- æ´»åŠ¨å°é¢ -->
  <view class="cover-section">
    <image class="cover-image" src="{{activity.cover}}" mode="aspectFill" />
    <view class="status-badge">
      <t-tag size="small" theme="success">{{activity.status}}</t-tag>
    </view>
  </view>

  <!-- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ -->
  <view class="info-section">
    <view class="activity-title">{{activity.title}}</view>
    
    <view class="info-list">
      <view class="info-item">
        <text class="info-icon">ğŸ“…</text>
        <text class="info-text">{{activity.dateRange}}</text>
      </view>
      <view class="info-item">
        <text class="info-icon">ğŸ“</text>
        <text class="info-text">{{activity.location}}</text>
      </view>
    </view>

    <!-- æ—…è¡Œé£æ ¼æ ‡ç­¾ -->
    <view class="tags-container">
      <t-tag wx:for="{{activity.tags}}" wx:key="*this" wx:for-item="tag" size="small" theme="primary">{{tag}}</t-tag>
    </view>

    <!-- æŠ¥åäººæ•° -->
    <view class="members-section">
      <view class="members-info">
        <text class="members-label">å·²æŠ¥å</text>
        <text class="members-count">{{activity.currentMembers}}</text>
        <text class="members-separator">/</text>
        <text class="members-max">{{activity.maxMembers}}</text>
        <text class="members-unit">äºº</text>
      </view>
      <view class="members-avatars" bindtap="onShowMembers">
        <t-avatar wx:for="{{activity.members}}" wx:key="id" wx:for-item="member" size="{{64}}" image="{{member.avatar}}" />
        <view class="more-members" wx:if="{{activity.members.length < activity.currentMembers}}">
          <text>+{{activity.currentMembers - activity.members.length}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¡Œç¨‹å®‰æ’ -->
  <view class="schedule-section">
    <view class="section-title">è¡Œç¨‹å®‰æ’</view>
    <view class="schedule-content-text">{{activity.description}}</view>
  </view>

  <!-- å‘èµ·äººä¿¡æ¯ -->
  <view class="creator-section">
    <view class="section-title">å‘èµ·äºº</view>
    <view class="creator-card">
      <t-avatar size="{{120}}" image="{{activity.creator.avatar}}" />
      <view class="creator-info">
        <view class="creator-name-row">
          <text class="creator-name">{{activity.creator.name}}</text>
          <t-tag size="small" theme="default">å‘èµ·äºº</t-tag>
        </view>
        <view class="creator-contact">
          <text class="contact-icon">ğŸ‘¤</text>
          <text class="contact-text">å¾®ä¿¡å·ï¼š{{activity.creator.wechat}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ¥åäººå‘˜åˆ—è¡¨ -->
  <view class="members-list-section">
    <view class="section-title">æŠ¥åäººå‘˜ï¼ˆ{{activity.currentMembers}}äººï¼‰</view>
    <view class="members-list">
      <view wx:for="{{activity.members}}" wx:key="id" wx:for-item="member" class="member-item">
        <t-avatar size="{{96}}" image="{{member.avatar}}" />
        <view class="member-info">
          <text class="member-name">{{member.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æŒ‰é’® -->
  <view class="footer-placeholder"></view>
  <view class="footer-bar">
    <t-button 
      wx:if="{{isRegistered && !isCreator}}" 
      theme="default" 
      size="large" 
      block 
      disabled
    >
      å·²æŠ¥å
    </t-button>
    <t-button 
      wx:elif="{{activity.currentMembers >= activity.maxMembers && !isCreator}}" 
      theme="default" 
      size="large" 
      block 
      disabled
    >
      å·²æ»¡å‘˜
    </t-button>
    <t-button 
      wx:else
      theme="primary" 
      size="large" 
      bindtap="{{isCreator ? 'onEditActivity' : 'onRegister'}}" 
      block
    >
      {{isCreator ? 'å®Œå–„æŠ¥åä¿¡æ¯' : 'ç«‹å³æŠ¥å'}}
    </t-button>
  </view>
</scroll-view>

<!-- æŠ¥åå¼¹çª— -->
<t-dialog visible="{{showRegisterDialog}}" title="æŠ¥åä¿¡æ¯" bind:confirm="onRegisterConfirm" bind:cancel="onRegisterCancel">
  <view class="register-form">
    <view class="form-item">
      <view class="form-label">å§“å/æ˜µç§° *</view>
      <t-input placeholder="è¯·è¾“å…¥å§“åæˆ–æ˜µç§°" value="{{registerForm.name}}" bind:change="onFormChange" data-field="name" />
    </view>
    <view class="form-item">
      <view class="form-label">æ€§åˆ« *</view>
      <t-radio-group value="{{registerForm.gender}}" bind:change="onGenderChange">
        <t-radio value="male" label="ç”·" />
        <t-radio value="female" label="å¥³" />
      </t-radio-group>
    </view>
    <view class="form-item">
      <view class="form-label">å¹´é¾„ï¼ˆå¯é€‰ï¼‰</view>
      <t-input type="digit" placeholder="è¯·è¾“å…¥å¹´é¾„" value="{{registerForm.age}}" bind:change="onFormChange" data-field="age" />
    </view>
    <view class="form-item">
      <view class="form-label">è”ç³»æ–¹å¼ *</view>
      <t-input placeholder="å¾®ä¿¡å·æˆ–æ‰‹æœºå·" value="{{registerForm.contact}}" bind:change="onFormChange" data-field="contact" />
    </view>
    <view class="form-item">
      <view class="form-label">è‡ªæˆ‘ä»‹ç»</view>
      <t-textarea placeholder="ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±..." value="{{registerForm.intro}}" bind:change="onFormChange" data-field="intro" maxlength="200" />
    </view>
  </view>
</t-dialog>

<!-- ç¼–è¾‘æ´»åŠ¨å¼¹çª— -->
<t-popup visible="{{showEditDialog}}" placement="bottom">
  <view class="edit-popup-container">
    <view class="edit-popup-header">
      <text class="edit-popup-title">ç¼–è¾‘æ´»åŠ¨</text>
      <view class="edit-popup-close" bindtap="onEditCancel">
        <text>Ã—</text>
      </view>
    </view>
    
    <scroll-view scroll-y class="edit-popup-content">
      <view class="edit-form">
        <!-- æ´»åŠ¨æ ‡é¢˜ -->
        <view class="form-item">
          <view class="form-label">æ´»åŠ¨æ ‡é¢˜ *</view>
          <t-input placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜" value="{{editForm.title}}" bind:change="onEditFieldChange" data-field="title" />
        </view>

        <!-- æ´»åŠ¨æ—¶é—´ -->
        <view class="form-item">
          <view class="form-label">æ´»åŠ¨æ—¶é—´ *</view>
          <view class="date-row">
            <view class="date-item">
              <view class="date-label">å¼€å§‹æ—¥æœŸ</view>
              <picker mode="date" value="{{editForm.startDate}}" bindchange="onEditStartDateChange">
                <view class="picker-content">{{editForm.startDate || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}</view>
              </picker>
            </view>
            <view class="date-item">
              <view class="date-label">ç»“æŸæ—¥æœŸ</view>
              <picker mode="date" value="{{editForm.endDate}}" bindchange="onEditEndDateChange">
                <view class="picker-content">{{editForm.endDate || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</view>
              </picker>
            </view>
          </view>
        </view>

        <!-- æ´»åŠ¨åœ°ç‚¹ -->
        <view class="form-item">
          <view class="form-label">æ´»åŠ¨åœ°ç‚¹ *</view>
          <view class="location-row">
            <t-input class="location-input" placeholder="è¯·è¾“å…¥åœ°ç‚¹" value="{{editForm.location}}" bind:change="onEditFieldChange" data-field="location" />
            <button class="location-btn" bindtap="onEditLocationSelect">
              <text class="location-icon">ğŸ“</text>
            </button>
          </view>
        </view>

        <!-- è¡Œç¨‹æè¿° -->
        <view class="form-item">
          <view class="form-label">è¡Œç¨‹æè¿° *</view>
          <t-textarea placeholder="è¯·æŒ‰å¤©æè¿°è¯¦ç»†çš„è¡Œç¨‹å®‰æ’..." value="{{editForm.description}}" bind:change="onEditFieldChange" data-field="description" maxlength="500" rows="6" />
        </view>

        <!-- æ—…è¡Œé£æ ¼ -->
        <view class="form-item">
          <view class="form-label">æ—…è¡Œé£æ ¼ *</view>
          <view class="tags-container">
            <t-tag 
              wx:for="{{styleTags}}" 
              wx:key="*this" 
              wx:for-item="tag"
              size="medium"
              theme="{{tagSelected[tag] === true ? 'primary' : 'default'}}"
              bindtap="onEditTagSelect"
              data-tag="{{tag}}"
            >
              {{tag}}
            </t-tag>
          </view>
        </view>

        <!-- äººæ•°ä¸Šé™ -->
        <view class="form-item">
          <view class="form-label">äººæ•°ä¸Šé™ *</view>
          <view class="stepper-container">
            <t-stepper 
              value="{{editForm.maxMembers}}" 
              min="2" 
              max="50" 
              bind:change="onEditMaxMembersChange"
            />
            <text class="stepper-unit">äºº</text>
          </view>
        </view>

        <!-- è”ç³»æ–¹å¼ -->
        <view class="form-item">
          <view class="form-label">è”ç³»æ–¹å¼ *</view>
          <t-input placeholder="å¾®ä¿¡å·æˆ–æ‰‹æœºå·" value="{{editForm.contact}}" bind:change="onEditFieldChange" data-field="contact" />
        </view>

        <!-- æ´»åŠ¨å°é¢ -->
        <view class="form-item">
          <view class="form-label">æ´»åŠ¨å°é¢</view>
          <view class="cover-upload-container">
            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <view wx:if="{{editForm.coverFiles.length > 0}}" class="cover-preview">
              <view wx:if="{{editForm.coverFiles[0].url}}" style="width: 100%; height: 100%;">
                <image class="cover-image" src="{{editForm.coverFiles[0].url}}" mode="aspectFill" />
              </view>
              <view wx:elif="{{editForm.coverFiles[0].path}}" style="width: 100%; height: 100%;">
                <image class="cover-image" src="{{editForm.coverFiles[0].path}}" mode="aspectFill" />
              </view>
              <view wx:elif="{{editForm.coverFiles[0].tempFilePath}}" style="width: 100%; height: 100%;">
                <image class="cover-image" src="{{editForm.coverFiles[0].tempFilePath}}" mode="aspectFill" />
              </view>
              <view wx:else style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">
                <text>æ— æ³•æ˜¾ç¤ºé¢„è§ˆï¼ˆè·¯å¾„ç¼ºå¤±ï¼‰</text>
              </view>
              <view class="cover-delete" bindtap="onEditCoverDelete">
                <text class="delete-icon">Ã—</text>
              </view>
            </view>
            <!-- ä¸Šä¼ æŒ‰é’®ï¼ˆåŠ å·ï¼‰ -->
            <t-upload
              class="cover-upload-btn"
              files="{{editForm.coverFiles}}"
              max="1"
              media-type="image"
              grid-config="{{gridConfig}}"
              bind:change="onEditCoverChange"
              bind:success="onEditUploadSuccess"
              bind:fail="onEditUploadFail"
              bind:progress="onEditUploadProgress"
            >
              <view slot="add-content" class="upload-add-btn" bindtap="onEditManualChooseImage">
                <text class="add-icon">+</text>
              </view>
            </t-upload>
          </view>
          <view class="upload-hint-text">å»ºè®®å°ºå¯¸ 750x400ï¼Œæ”¯æŒ JPGã€PNG</view>
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="edit-popup-footer">
      <t-button theme="danger" size="large" bindtap="onDeleteActivity" style="margin-right: 16rpx; flex: 1;">
        åˆ é™¤æ´»åŠ¨
      </t-button>
      <t-button theme="primary" size="large" bindtap="onEditConfirm" style="flex: 1;">
        ä¿å­˜ä¿®æ”¹
      </t-button>
    </view>
  </view>
</t-popup>

